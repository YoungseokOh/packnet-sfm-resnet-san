# Consistency Weight ë° 48 ë ˆë²¨ì— ëŒ€í•œ ì™„ì „ ì„¤ëª…

## ì§ˆë¬¸ 1: Consistency WeightëŠ” ì™œ 1ë¡œ ì¤˜ì•¼ í•˜ëŠ”ê°€?

### ğŸ“‹ ì§§ì€ ë‹µë³€
**"1ë¡œ ê¼­ ì¤„ í•„ìš”ëŠ” ì—†ìŠµë‹ˆë‹¤"** - í˜„ì¬ëŠ” **0.5**ê°€ ê¸°ë³¸ê°’ì…ë‹ˆë‹¤.

```python
# í˜„ì¬ ì½”ë“œ (packnet_sfm/losses/dual_head_depth_loss.py, ë¼ì¸ 49-51)
def __init__(self, max_depth=15.0, 
             integer_weight=1.0,        # â† Integer ì†ì‹¤ ê°€ì¤‘ì¹˜
             fractional_weight=10.0,    # â† Fractional ì†ì‹¤ ê°€ì¤‘ì¹˜ (í•µì‹¬!)
             consistency_weight=0.5,    # â† ì¼ê´€ì„± ì†ì‹¤ ê°€ì¤‘ì¹˜ (0.5ê°€ ê¸°ë³¸ê°’)
             min_depth=0.5):
```

---

## ğŸ¯ Consistency Weightê°€ ë¬´ì—‡ì¸ê°€?

### Loss í•¨ìˆ˜ì˜ êµ¬ì¡°

```
Total Loss = 1.0 Ã— L_integer 
           + 10.0 Ã— L_fractional 
           + 0.5 Ã— L_consistency   â† ì´ê²Œ consistency_weight
```

### ì„¸ ê°€ì§€ ì†ì‹¤ ì»´í¬ë„ŒíŠ¸

#### 1ï¸âƒ£ **Integer Loss** (ì •ìˆ˜ë¶€ ì†ì‹¤)
```
L_integer = |Integer_pred - Integer_gt|
           = |depth_pred // 1.0 - depth_gt // 1.0|

ëª©í‘œ: Integer head (ì •ìˆ˜ë¶€)ê°€ ì •í™•í•˜ê²Œ ì˜ˆì¸¡í•˜ê¸°
ì˜ˆ: ê¹Šì´ê°€ 5.3mì´ë©´ Integer = 5 ì˜ˆì¸¡í•´ì•¼ í•¨
```

#### 2ï¸âƒ£ **Fractional Loss** (ì†Œìˆ˜ë¶€ ì†ì‹¤)
```
L_fractional = |Fractional_pred - Fractional_gt|
             = |depth_pred % 1.0 - depth_gt % 1.0|

ëª©í‘œ: Fractional head (ì†Œìˆ˜ë¶€)ê°€ ì •ë°€í•˜ê²Œ ì˜ˆì¸¡í•˜ê¸°
ì˜ˆ: ê¹Šì´ê°€ 5.3mì´ë©´ Fractional = 0.3m ì˜ˆì¸¡í•´ì•¼ í•¨
```

#### 3ï¸âƒ£ **Consistency Loss** (ì¼ê´€ì„± ì†ì‹¤) â­ ì¤‘ìš”!
```
depth_reconstructed = integer_pred Ã— max_depth + fractional_pred Ã— 1m
L_consistency = |depth_reconstructed - depth_gt|

ëª©í‘œ: ë‘ í—¤ë“œë¥¼ ê²°í•©í•œ ìµœì¢… ê¹Šì´ê°€ ì •í™•í•˜ê¸°
```

### ì‹œê°ì  ì„¤ëª…

```
Input RGB ì´ë¯¸ì§€
         â†“
    [ResNet]
         â†“
      â”Œâ”€â”€â”´â”€â”€â”
      â†“     â†“
   [Integer] [Fractional]  â† 2ê°œ í—¤ë“œê°€ ë…ë¦½ì ìœ¼ë¡œ ì˜ˆì¸¡
   (0~15m)   (0~1m)
      â†“     â†“
      â””â”€â”€â”¬â”€â”€â”˜
    depth_reconstructed = integer Ã— 15 + fractional Ã— 1
         â†“
    [L_consistency ê³„ì‚°]
         â†“
    Consistency Lossì„ í†µí•´
    "ë‘ í—¤ë“œê°€ í˜‘ë ¥í•˜ëŠ”ê°€?" ê²€ì¦
```

---

## ğŸ’¡ Consistency Weightê°€ **0.5ì¸ ì´ìœ ** (ì™œ 1ì´ ì•„ë‹Œê°€?)

### ìƒí™© ë¹„êµ

```python
# ì¼€ì´ìŠ¤ 1: consistency_weight = 0.5 (í˜„ì¬)
total_loss = 1.0 Ã— L_int + 10.0 Ã— L_frac + 0.5 Ã— L_cons
            â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
             ì •ìˆ˜ë¶€ í•™ìŠµ     ì†Œìˆ˜ë¶€ í•™ìŠµ    í˜‘ë ¥ ê²€ì¦

# ì¼€ì´ìŠ¤ 2: consistency_weight = 1.0 (1ë¡œ ë†’ì´ëŠ” ê²½ìš°)
total_loss = 1.0 Ã— L_int + 10.0 Ã— L_frac + 1.0 Ã— L_cons
                                          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                                          í˜‘ë ¥ ê²€ì¦ 2ë°° ê°•ì¡°

# ì¼€ì´ìŠ¤ 3: consistency_weight = 0.0 (ì œê±°í•œ ê²½ìš°)
total_loss = 1.0 Ã— L_int + 10.0 Ã— L_frac
# ë‘ í—¤ë“œ í˜‘ë ¥ ê²€ì¦ ì—†ìŒ â†’ Integerì™€ Fractionalì´ ë…ë¦½ì ìœ¼ë¡œ í•™ìŠµ
```

### Consistency Weight ì„ íƒ ê¸°ì¤€

| Weight | ì˜ë¯¸ | ì¥ì  | ë‹¨ì  |
|--------|------|------|------|
| **0.0** | ì¼ê´€ì„± ë¬´ì‹œ | Integer/Fractional ë…ë¦½ í•™ìŠµ | ë‘ í—¤ë“œ ë¹„í˜‘ë ¥ ê°€ëŠ¥ |
| **0.25** | ì•½í•œ í˜‘ë ¥ | ê° í—¤ë“œ ë…ë¦½ì„± ìœ ì§€ | ì¼ê´€ì„± ë³´ì¥ ì•½í•¨ |
| **0.5** â­ | ê· í˜•ìˆëŠ” í˜‘ë ¥ | ê¶Œì¥ ì„¤ì • (í˜„ì¬) | íŠ¹ë³„í•œ ë‹¨ì  ì—†ìŒ |
| **1.0** | ê°•í•œ í˜‘ë ¥ | ì¼ê´€ì„± ê°•ì œ | ê°œë³„ í—¤ë“œ ì„±ëŠ¥ â†“ ê°€ëŠ¥ |
| **2.0+** | ê·¹ê°• í˜‘ë ¥ | ìµœì¢… ê¹Šì´ ê°•ì¡° | Integer/Fractional ìš°íšŒ ê°€ëŠ¥ |

### ìˆ˜ì¹˜ ì˜ˆì‹œ

```
í…ŒìŠ¤íŠ¸ ê¹Šì´: 8.5m
Ground Truth:
  - Integer: 8 (0~15 ì •ê·œí™” â†’ 0.533)
  - Fractional: 0.5 (0~1)

ì˜ˆì¸¡ ê²°ê³¼:
  - Integer_pred: 0.534 (ì˜¤ì°¨: 0.001)
  - Fractional_pred: 0.49 (ì˜¤ì°¨: 0.01)

ì†ì‹¤ ê³„ì‚° (ê° ê°€ì¤‘ì¹˜ë³„):

1ï¸âƒ£  consistency_weight = 0.5 (í˜„ì¬)
   L_int = 0.001
   L_frac = 0.01
   L_cons = |0.534Ã—15 + 0.49 - 8.5| = |8.51 - 8.5| = 0.01
   
   Total = 1.0Ã—0.001 + 10.0Ã—0.01 + 0.5Ã—0.01
         = 0.001 + 0.10 + 0.005
         = 0.106  âœ“ ê· í˜•

2ï¸âƒ£  consistency_weight = 1.0
   Total = 1.0Ã—0.001 + 10.0Ã—0.01 + 1.0Ã—0.01
         = 0.001 + 0.10 + 0.01
         = 0.111  (ì¼ê´€ì„± ê²€ì¦ ê°•í™”)

3ï¸âƒ£  consistency_weight = 0.0
   Total = 1.0Ã—0.001 + 10.0Ã—0.01
         = 0.001 + 0.10
         = 0.101  (í˜‘ë ¥ ê²€ì¦ ì—†ìŒ)
```

---

### ìµœì  ê°’ ì„ íƒ ê¸°ì¤€

#### âœ… **consistency_weight = 0.5 ì¶”ì²œ**
```
í˜„ì¬ ì„¤ì •ì´ ìµœì ì¸ ì´ìœ :
  - Integerì™€ Fractionalì´ ì¶©ë¶„íˆ ë…ë¦½ì ìœ¼ë¡œ í•™ìŠµ
  - í•˜ì§€ë§Œ ìµœì¢… ê¹Šì´ ì¼ê´€ì„±ë„ ë³´ì¥
  - min_depth ì¡°ì ˆ ì‹œì—ë„ ì´ ê°’ ìœ ì§€ ê¶Œì¥
```

#### âš ï¸ **consistency_weight = 1.0 ê³ ë ¤**
```
ì–¸ì œ ëŠ˜ë ¤ì•¼ í•˜ëŠ”ê°€?
  - min_depthë¥¼ ê·¹ë„ë¡œ ë‚®ì¶œ ë•Œ (0.01m)
  - í•™ìŠµ ë²”ìœ„ê°€ ë§¤ìš° ë„“ì–´ì§ˆ ë•Œ (ë²”ìœ„: 1500ë°°)
  - ì¥ì : í•™ìŠµ ì•ˆì •í™”
  - ìˆ˜ì •: consistency_weight: 0.5 â†’ 1.0
```

#### âŒ **consistency_weight = 0 ë¹„ê¶Œì¥**
```
ì œê±°í•˜ë©´ ì•ˆ ë˜ëŠ” ì´ìœ :
  - Integerì™€ Fractionalì´ ë…ë¦½ì ìœ¼ë¡œ ë°œì‚° ê°€ëŠ¥
  - ìµœì¢… ë³µì› ê¹Šì´ê°€ ë¶€ì •í™•í•  ìˆ˜ ìˆìŒ
  - ë‘ í—¤ë“œ ê°„ í˜‘ë ¥ ë©”ì»¤ë‹ˆì¦˜ ì œê±°
```

---

## ì§ˆë¬¸ 2: "48"ì´ ë­ì•¼?

### ğŸ“‹ ì§§ì€ ë‹µë³€
**"Integer headì˜ ì •ë³´ ìš©ëŸ‰ì´ ì•½ 48 ë ˆë²¨ì´ë¼ëŠ” ì˜ë¯¸"**

```
Integer headê°€ í‘œí˜„í•  ìˆ˜ ìˆëŠ” ì„œë¡œ ë‹¤ë¥¸ ìƒíƒœ:
  â‰ˆ 48ê°œ ìˆ˜ì¤€ (5.58 bits ì •ë³´)
  
ë¹„êµ:
  - Fractional head: 1m ë²”ìœ„ì—ì„œ â‰ˆ 256ê°œ ìˆ˜ì¤€ (8 bits PTQ)
  - Integer head (Float32): 0~15mì„ 48ê°œ ë ˆë²¨ë¡œ í‘œí˜„
```

---

## ğŸ” "48 ë ˆë²¨"ì˜ êµ¬ì²´ì  ì˜ë¯¸

### 1ï¸âƒ£ **Multi-Scale Feature Map êµ¬ì¡°**

ResNet ì¸ì½”ë”-ë””ì½”ë” êµ¬ì¡°ì—ì„œ:

```
ì…ë ¥ í•´ìƒë„: 640 Ã— 384
    â†“
[ResNet ì¸ì½”ë”]
    â†“
    â”œâ”€ Scale 0: 640Ã·8 = 80  (width)
    â”œâ”€ Scale 1: 640Ã·16 = 40 (width)  
    â”œâ”€ Scale 2: 640Ã·32 = 20 (width)
    â””â”€ Scale 3: 640Ã·64 = 10 (width)

ê° scaleì˜ ë†’ì´ (384 ê¸°ì¤€):
    â”œâ”€ Scale 0: 384Ã·8 = 48  (height) â† ì´ê²Œ "48"!
    â”œâ”€ Scale 1: 384Ã·16 = 24 (height)
    â”œâ”€ Scale 2: 384Ã·32 = 12 (height)
    â””â”€ Scale 3: 384Ã·64 = 6  (height)
```

**ë”°ë¼ì„œ 48ì€**:
- ResNet ë””ì½”ë” ìµœìƒìœ„ ë ˆë²¨(Scale 3)ì˜ height
- **ì¦‰, 48 Ã— 80ì˜ feature map**ì—ì„œ Integer/Fractionalì´ ì˜ˆì¸¡ë¨

### 2ï¸âƒ£ **ì •ë³´ ìš©ëŸ‰ ê³„ì‚°**

```python
# ì½”ë“œ (analyze_loss_weight_justification.py, ë¼ì¸ 22)
INTEGER_INTERVAL = MAX_DEPTH / 48  # ResNet ì¶œë ¥ì´ 48xë³´ë‹¤ ì‘ìŒ
                 = 15.0 / 48
                 = 0.3125m ê°„ê²©

# ì¦‰, ì •ìˆ˜ë¶€ê°€ 0.3125m ê°„ê²©ìœ¼ë¡œ 15ê°€ì§€ ìƒíƒœë¥¼ í‘œí˜„
# 0 â†’ 0.3125 â†’ 0.625 â†’ 0.9375 â†’ ... â†’ 15.0m (ì´ 48ë ˆë²¨)

ì •ë³´ ìš©ëŸ‰ = log2(48) = 5.58 bits
```

### 3ï¸âƒ£ **ì½”ë“œì—ì„œ ëª…ì‹œëœ ìœ„ì¹˜**

```python
# ë¼ì¸ 41 (analyze_dual_head_loss.py)
n_int_levels = 48

# ë¼ì¸ 38 (validate_loss_weight_numerically.py)
N_INT_LEVELS = 48         # Integer head ì–‘ìí™” ë ˆë²¨

# ë¼ì¸ 178 (analyze_loss_weight_justification.py)
# Integer: 0~15mì„ 48ë‹¨ê³„ë¡œ ë¶„í•  â†’ ì•½ 5.6 bits
```

---

## ğŸ“Š 48 vs 256 ë¹„êµ

### **ì„¤ê³„ ì˜ë„**

#### Integer Head (48 ë ˆë²¨)
```
ëª©í‘œ: ì •ìˆ˜ë¶€ì˜ "ëŒ€ëµì " ìœ„ì¹˜ íŒŒì•… (coarse prediction)

0m â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤ 15m
   â”‚     â”‚     â”‚     â”‚
   0    48   96   144  192  240  288  (48ê°œ ê²½ê³„)
   
ê° ê°„ê²©: 15m / 48 = 312.5mm (ì•½ 31cm)
ì •ë³´: log2(48) = 5.58 bits
```

#### Fractional Head (256 ë ˆë²¨)
```
ëª©í‘œ: ì†Œìˆ˜ë¶€ì˜ "ì •ë°€í•œ" ìœ„ì¹˜ íŒŒì•… (fine prediction)

0m â”œâ”€â”¼â”€â”¼â”€â”¼â”€â”¤ 1m
  0 1 2 3 ... 255  (256ê°œ ê²½ê³„)
   
ê° ê°„ê²©: 1m / 255 = 3.92mm
ì •ë³´: 8 bits (PTQì—ì„œ 8-bit ì–‘ìí™”ì™€ ì¼ì¹˜)
```

### **ì™œ Integer = 48ì´ê³  Fractional = 256ì¸ê°€?**

| í•­ëª© | Integer (48) | Fractional (256) | ì´ìœ  |
|-----|------------|-----------------|------|
| **ì •ë³´ ëª©í‘œ** | ë²”ìœ„ ìœ„ì¹˜ íŒŒì•… | ì •ë°€ ìœ„ì¹˜ íŒŒì•… | ì—­í•  ë¶„ë‹´ |
| **ê³„ì‚° ë³µì¡ë„** | ì € (5.58 bits) | ë†’ (8 bits) | íš¨ìœ¨ì„± |
| **ì†ì‹¤ í•¨ìˆ˜ ì—­í• ** | 1Ã— ê°€ì¤‘ì¹˜ | 10Ã— ê°€ì¤‘ì¹˜ | Fractionalì´ í•µì‹¬ |
| **PTQ ë°°í¬ í›„** | 256 ë ˆë²¨ë¡œ ì–‘ìí™” | 256 ë ˆë²¨ ìœ ì§€ | ì–‘ìª½ ë‹¤ 8-bit |
| **ë‹¤ì¤‘ìŠ¤ì¼€ì¼ ì¶œë ¥** | 48Ã—80 (feature map) | 48Ã—80 (feature map) | ë™ì¼ í•´ìƒë„ |

---

## ğŸ¯ ìµœì¢… ì •ë¦¬

### Consistency Weight (ì²« ë²ˆì§¸ ì§ˆë¬¸)

```
ê¸°ë³¸ ê°’: 0.5 (í˜„ì¬)

â”Œâ”€ 0.5: ê· í˜•ìˆëŠ” í˜‘ë ¥ (ê¶Œì¥) âœ“
â”œâ”€ 1.0: ê°•í•œ í˜‘ë ¥ (min_depth ê·¹ë‹¨ì  ì¡°ì • ì‹œ)
â””â”€ 0.0: í˜‘ë ¥ ë¬´ì‹œ (ë¹„ê¶Œì¥)

ì—­í• : Integerì™€ Fractional í—¤ë“œê°€ 
      ìµœì¢… ê¹Šì´ ì˜ˆì¸¡ì—ì„œ í˜‘ë ¥í•˜ëŠ”ì§€ ê²€ì¦
```

### 48 ë ˆë²¨ (ë‘ ë²ˆì§¸ ì§ˆë¬¸)

```
ì˜ë¯¸: Integer headì˜ ì •ë³´ ìš©ëŸ‰

êµ¬ì¡°:
  - ResNet ì¶œë ¥: 48 Ã— 80 (feature map í•´ìƒë„)
  - ì •ë³´: log2(48) = 5.58 bits
  - ê°„ê²©: 15m Ã· 48 = 312.5mm

ì„¤ê³„: ì •ìˆ˜ë¶€ (ë²”ìœ„) ë‹´ë‹¹, ì†Œìˆ˜ë¶€ (ì •ë°€ë„) ë‹´ë‹¹
      â†’ ê° í—¤ë“œ ì—­í•  ë¶„ë‹´ìœ¼ë¡œ ìµœì í™”
```

---

## ğŸ“š ì°¸ê³  íŒŒì¼

1. **ì†ì‹¤í•¨ìˆ˜ êµ¬í˜„**: `packnet_sfm/losses/dual_head_depth_loss.py`
2. **ìˆ˜í•™ì  ì¦ëª…**: `docs/implementation/DUAL_HEAD_LOSS_WEIGHT_JUSTIFICATION.md`
3. **ë¶„ì„ ìŠ¤í¬ë¦½íŠ¸**: `analyze_dual_head_loss.py`, `validate_loss_weight_numerically.py`

---

## ğŸ’¬ ì¶”ê°€ ì§ˆë¬¸

### Q: Consistency weightë¥¼ 0.5ì—ì„œ 1.0ìœ¼ë¡œ ë³€ê²½í•˜ë ¤ë©´?

```bash
# ë°©ë²• 1: ì½”ë“œ ìˆ˜ì •
# packnet_sfm/losses/dual_head_depth_loss.py, ë¼ì¸ 51
consistency_weight=0.5,  # â†’ 1.0 ë³€ê²½

# ë°©ë²• 2: Config íŒŒì¼ ìˆ˜ì •
# configs/train_resnet_san_ncdb_dual_head_640x384.yaml
model:
  loss:
    consistency_weight: 1.0

# ë°©ë²• 3: ëª…ë ¹í–‰ ì˜¤ë²„ë¼ì´ë“œ
python train.py \
    --config configs/train_resnet_san_ncdb_dual_head_640x384.yaml \
    --loss_consistency_weight 1.0
```

### Q: 48ì„ ë‹¤ë¥¸ ê°’ìœ¼ë¡œ ë°”ê¿€ ìˆ˜ ìˆë‚˜?

```
ì•„ë‹ˆì˜¤. 48ì€ ê³ ì •ê°’ì…ë‹ˆë‹¤.

ì´ìœ :
  - ResNet ì¸ì½”ë”-ë””ì½”ë”ì˜ ê³ ì •ëœ êµ¬ì¡°
  - (640Ã·8) = 80, (384Ã·8) = 48 (ì…ë ¥ í•´ìƒë„ ê¸°ì¤€)
  - ë³€ê²½í•˜ë ¤ë©´ ì¸ì½”ë”-ë””ì½”ë” ì•„í‚¤í…ì²˜ ìì²´ ìˆ˜ì • í•„ìš”
  - ë”°ë¼ì„œ ê±´ë“œë¦¬ë©´ ì•ˆ ë¨!

ë³€ìˆ˜ëŠ” Integer headì˜ "ê°€ì¤‘ì¹˜"ì´ì§€, ë ˆë²¨ ìì²´ê°€ ì•„ë‹˜
â†’ fractional_weight (10.0)ë¥¼ ì¡°ì •í•  ê²ƒ
```

### Q: Fractional weight 10.0ê³¼ Consistency weight 0.5ì˜ ê´€ê³„?

```python
# ì†ì‹¤ ë¹„ì¤‘
Integer loss:       1.0 Ã— L_int       â†’ ~9% ê¸°ì—¬
Fractional loss:   10.0 Ã— L_frac     â†’ ~87% ê¸°ì—¬
Consistency loss:   0.5 Ã— L_cons     â†’ ~4% ê¸°ì—¬

ì¦‰:
  - Fractional (ì†Œìˆ˜ë¶€)ì´ ë©”ì¸ í•™ìŠµ (87%)
  - Consistencyê°€ í˜‘ë ¥ ê²€ì¦ (4%)
  - Integerê°€ ë³´ì¡° (9%)
  
ì´ ë¹„ìœ¨ì´ ìµœì  ì„¤ê³„!
```

