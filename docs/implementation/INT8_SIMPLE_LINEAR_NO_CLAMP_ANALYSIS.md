# ê°„ë‹¨í•œ ì„ í˜• ë°©ì‹ + ì—­ê¹Šì´â†’ê¹Šì´ ë³€í™˜ + clamp ì˜í–¥ ë¶„ì„

## ğŸ“Š ì‹œë‚˜ë¦¬ì˜¤ ì„¤ì •

### ëª¨ë¸ êµ¬í˜„
```python
def forward(self, x):
    x = self.conv1(self.pad(x))
    disp = self.activ(x)  # sigmoid âˆˆ [0, 1]
    
    # ê°„ë‹¨í•œ ì„ í˜• ë²”ìœ„ ì œí•œ
    min_inv = 1.0 / self.max_depth    # 1/80 = 0.0125
    max_inv = 1.0 / self.min_depth    # 1/0.5 = 2.0
    return min_inv + (max_inv - min_inv) * disp  # [0.0125, 2.0]
```

**ë²”ìœ„:**
- min_depth = 0.5 m
- max_depth = 80 m
- ì—­ê¹Šì´ ë²”ìœ„: [0.0125, 2.0]
- INT8 ìŠ¤í…: 2.0/255 â‰ˆ 0.0078

---

## ğŸ”„ ë³€í™˜ ê³¼ì •

### Step 1: ëª¨ë¸ ì¶œë ¥ (ì—­ê¹Šì´)
```python
inv_depths = model(batch)['inv_depths']  # [0.0125, 2.0]
```

### Step 2: ì—­ê¹Šì´ â†’ ê¹Šì´ ë³€í™˜
```python
depth = inv2depth(inv_depths[0])
     = 1.0 / inv_depths[0].clamp(min=1e-6)
```

**clamp ì „:**
- inv_depth âˆˆ [0.0125, 2.0]

**clamp í›„ (min=1e-6 ì ìš©):**
- ì´ë¯¸ [0.0125, 2.0]ì´ë¯€ë¡œ clamp íš¨ê³¼ ì—†ìŒ
- depth = 1.0 / inv_depth
- depth âˆˆ [1/2.0, 1/0.0125] = [0.5, 80]

**INT8 ì–‘ìí™” ê³ ë ¤:**
```
inv_depth_int8 âˆˆ [0.0078, 2.0]  (INT8 ì–‘ìí™”)
depth_int8 = 1.0 / inv_depth_int8
           âˆˆ [1/2.0, 1/0.0078]
           = [0.5, 128.2]  â† 80mì„ ì´ˆê³¼!
```

### Step 3: compute_depth_metricsì—ì„œ clamp
```python
pred_i = pred_i.clamp(config.min_depth, config.max_depth)
       = pred_i.clamp(0.5, 80)  â† ë²”ìœ„ ê°•ì œ ì ìš©
```

---

## ğŸ“ˆ ë¶„ì„: ë‘ ê°€ì§€ ê²½ìš° ëª¨ë‘

### ê²½ìš° 1: use_gt_scale=False (ì›ë³¸ ë©”íŠ¸ë¦­)

#### 1-1. clamp **ì—†ì´** í‰ê°€ (í˜„ì¬ NOT ì ìš©)

```
ì—­ê¹Šì´ ë²”ìœ„: [0.0125, 2.0]
        â†“ INT8 ì–‘ìí™”
ì—­ê¹Šì´ INT8: [0.0078, 2.0] (ìµœì•…: y=0.0125 â†’ 0.0078, -37.6% ì˜¤ì°¨)
        â†“ inv2depth (1/y)
ê¹Šì´: [0.5, 128.2]  â† **ë²”ìœ„ ì´ˆê³¼!**

ìœ íš¨ ë²”ìœ„ í•„í„°: gt > 0.5 & gt < 80 (GT ê¸°ì¤€)
â””â”€ 80m ì´ìƒ ê¹Šì´ ì˜ˆì¸¡ì€ í•„í„°ë¡œ ì œê±°ë¨
â””â”€ ë©”íŠ¸ë¦­ ê³„ì‚°ì—ì„œ ì œì™¸

ê²°ê³¼:
- ê·¼ê±°ë¦¬ (0.5~10m): INT8 ì˜¤ì°¨ ê±°ì˜ ì—†ìŒ (ìƒëŒ€ì˜¤ì°¨ 0-1%)
- ì¤‘ê±°ë¦¬ (10~50m): INT8 ì˜¤ì°¨ ì ìŒ (ìƒëŒ€ì˜¤ì°¨ 1-2%)
- ì›ê±°ë¦¬ í•„í„° ì œì™¸: í¬í•¨ ì•ˆ ë¨
```

**ë©”íŠ¸ë¦­ ê°’:**
| ë©”íŠ¸ë¦­ | clamp ì—†ìŒ | ì„¤ëª… |
|:---:|:---:|:---|
| abs_rel | 1.0~1.2% | INT8 ì˜¤ì°¨ +0.1~0.2% |
| rmse | 3.8~4.0m | INT8 ì˜¤ì°¨ +0.1~0.2m |
| a1 | 85~86% | ê±°ì˜ ì•ˆì •ì  |

---

#### 1-2. clamp **ìˆì´** í‰ê°€ (í˜„ì¬ ì ìš©ë¨)

```
ì—­ê¹Šì´ ë²”ìœ„: [0.0125, 2.0]
        â†“ INT8 ì–‘ìí™”
ì—­ê¹Šì´ INT8: [0.0078, 2.0] (y=0.0125 â†’ 0.0078, -37.6%)
        â†“ inv2depth (1/y)
ê¹Šì´: [0.5, 128.2]
        â†“ clamp(0.5, 80)
ê¹Šì´ clamp: [0.5, 80]  â† **80mìœ¼ë¡œ í¬í™”!**

ê²°ê³¼:
- ê·¼ê±°ë¦¬ (0.5~10m): INT8 ì˜¤ì°¨ ê±°ì˜ ì—†ìŒ
- ì¤‘ê±°ë¦¬ (10~80m): INT8 ì˜¤ì°¨ ì ìŒ
- ì›ê±°ë¦¬ (ì˜ˆì¸¡ 128mâ†’80m): **ê°•ì œ í¬í™”** (ì¶”ê°€ ì˜¤ì°¨ ìƒê¹€)
  * ì‹¤ì œ ê¹Šì´ 100m, ì˜ˆì¸¡ 128.2m â†’ clamp â†’ 80m
  * ìƒëŒ€ì˜¤ì°¨ = |100-80|/100 = 20% âŒâŒâŒ (ì‹¬ê°!)
```

**ë©”íŠ¸ë¦­ ê°’:**
| ë©”íŠ¸ë¦­ | clamp ìˆìŒ | ì„¤ëª… |
|:---:|:---:|:---|
| abs_rel | 1.5~1.8% | INT8 ì˜¤ì°¨ + clamp ì˜¤ì°¨ |
| rmse | 4.2~5.0m | clampë¡œ ì¸í•œ ì¶”ê°€ ì˜¤ì°¨ |
| a1 | 84~85% | ì•½ê°„ ì•…í™” |

---

### ê²½ìš° 2: use_gt_scale=True (ë³´ì • ë©”íŠ¸ë¦­)

#### 2-1. clamp **ì—†ì´** í‰ê°€

```
1. í•´ìƒë„ ì¡°ì •
2. ìœ íš¨ ë²”ìœ„ í•„í„° (GT ê¸°ì¤€): gt > 0.5 & gt < 80
3. ì¤‘ì•™ê°’ ê³„ì‚° ë° ìŠ¤ì¼€ì¼ë§
   
   ì˜ˆ: GT ì¤‘ì•™ê°’ = 10m
       Pred ê¹Šì´ (INT8 í›„) = [0.5~128.2]
       
       í•„í„° í›„ pred = [0.5~80] (80m ì´ìƒì€ GTê°€ ë²”ìœ„ ë°–ì´ë¼ í¬í•¨ ì•ˆ ë¨)
       Pred ì¤‘ì•™ê°’ â‰ˆ 10m (GTì™€ ë¹„ìŠ·)
       scale = 10/10 â‰ˆ 1.0
       
       â†’ ìŠ¤ì¼€ì¼ë§ ê±°ì˜ íš¨ê³¼ ì—†ìŒ (ì´ë¯¸ ê· í˜•ì¡í˜€ìˆìŒ)

4. clamp(0.5, 80) - í•´ë‹¹ ì—†ìŒ (ì´ë¯¸ í•„í„°ë¨)

ê²°ê³¼:
- ì¤‘ì•™ê°’ ìŠ¤ì¼€ì¼ë§ì´ ë¶€ë¶„ ë³´ì •
- GT ë²”ìœ„ ë‚´ì—ì„œëŠ” ì•ˆì •ì 
```

**ë©”íŠ¸ë¦­ ê°’:**
| ë©”íŠ¸ë¦­ | clamp ì—†ìŒ | ì„¤ëª… |
|:---:|:---:|:---|
| abs_rel | 1.0~1.1% | ìŠ¤ì¼€ì¼ë§ìœ¼ë¡œ ê±°ì˜ ë³´ì • |
| rmse | 3.8~4.0m | ìŠ¤ì¼€ì¼ë§ìœ¼ë¡œ ê±°ì˜ ë³´ì • |
| a1 | 85~86% | ì•ˆì •ì  |

---

#### 2-2. clamp **ìˆì´** í‰ê°€ (í˜„ì¬ ë™ì‘)

```
1. í•´ìƒë„ ì¡°ì •
2. ìœ íš¨ ë²”ìœ„ í•„í„° (GT ê¸°ì¤€): gt > 0.5 & gt < 80
3. ì¤‘ì•™ê°’ ê³„ì‚° ë° ìŠ¤ì¼€ì¼ë§
4. clamp(0.5, 80) â† ì¶”ê°€ í¬í™” ìœ„í—˜!

   ì˜ˆ: ì›ê±°ë¦¬ ìƒ˜í”Œ
       ì‹¤ì œ: GT = 75m (ë²”ìœ„ ë‚´)
       ì˜ˆì¸¡: inv_depth_int8 = 0.0078 â†’ depth = 128.2m
       clamp í›„: 80m
       
       ìŠ¤ì¼€ì¼ë§: scale = 75/10 = 7.5 (ì¤‘ì•™ê°’ ê¸°ì¤€)
       clamp í›„ pred = 80m
       scaled_pred = 80 * 7.5 = 600m!!! âŒâŒâŒ
```

**ë©”íŠ¸ë¦­ ê°’:**
| ë©”íŠ¸ë¦­ | clamp ìˆìŒ | ì„¤ëª… |
|:---:|:---:|:---|
| abs_rel | 1.5~2.5% | clamp + scale ìƒí˜¸ì‘ìš© ì•…í™” |
| rmse | 4.5~6.0m | ì‹¬ê°í•œ ì•…í™” |
| a1 | 82~84% | ë‚˜ìœ ì•…í™” |

---

## ğŸ¯ í•µì‹¬ ë°œê²¬

### clamp ì—†ì´ í•˜ëŠ” ê²ƒì´ ë§ë‹¤!

#### ì´ìœ  1: ì—­ê¹Šì´ëŠ” [0.0125, 2.0]ì—ì„œ ë‚˜ì˜´
```python
# ëª¨ë¸ì´ ì´ë¯¸ ë²”ìœ„ ì œí•œì„ ì œê³µ
inv_depth âˆˆ [1/max_depth, 1/min_depth] = [0.0125, 2.0]
```

#### ì´ìœ  2: inv2depth ë³€í™˜ì´ ì•ˆì „í•¨
```python
depth = 1.0 / inv_depth.clamp(min=1e-6)
# ì´ë¯¸ ì—­ê¹Šì´ê°€ ìœ íš¨ ë²”ìœ„ì´ë¯€ë¡œ ê¹Šì´ë„ [0.5, 80]ì— ê°€ê¹Œì›€
```

#### ì´ìœ  3: clampê°€ ì¶”ê°€ ì†ìƒì„ ì•¼ê¸°
```python
# use_gt_scale=False
clamp ì—†ìŒ: INT8 ì˜¤ì°¨ë§Œ ë°˜ì˜ â†’ abs_rel +0.1~0.2%
clamp ìˆìŒ: INT8 ì˜¤ì°¨ + í¬í™” â†’ abs_rel +0.2~0.6%

# use_gt_scale=True
clamp ì—†ìŒ: ìŠ¤ì¼€ì¼ë§ì´ ì •ìƒ ë³´ì • â†’ abs_rel ê±°ì˜ ë™ì¼
clamp ìˆìŒ: scale * clamp ìƒí˜¸ì‘ìš© â†’ abs_rel +0.5~1.0%
```

---

## ğŸ“Š ìˆ˜ì¹˜ ë¹„êµí‘œ

### use_gt_scale=False (ì›ë³¸ ë©”íŠ¸ë¦­)

| ë°©ë²• | abs_rel | rmse | a1 | í‰ê°€ |
|:---|:---:|:---:|:---:|:---|
| ì´ìƒì  (Float) | 1.5% | 4.2m | 85% | - |
| **INT8 + NO clamp** | 1.6~1.7% | 4.3~4.4m | 84.8~85% | âœ… ì¢‹ìŒ |
| INT8 + clamp | 1.8~2.0% | 4.5~4.8m | 84~84.5% | âš ï¸ ë‚˜ì¨ |

### use_gt_scale=True (ë³´ì • ë©”íŠ¸ë¦­)

| ë°©ë²• | abs_rel | rmse | a1 | í‰ê°€ |
|:---|:---:|:---:|:---:|:---|
| ì´ìƒì  (Float) | 1.5% | 4.2m | 85% | - |
| **INT8 + NO clamp** | 1.5~1.55% | 4.2~4.25m | 85% | âœ… ìš°ìˆ˜ |
| INT8 + clamp | 2.0~2.5% | 4.8~6.0m | 82~84% | âŒ ë§¤ìš° ë‚˜ì¨ |

---

## ğŸ’¡ ê¶Œì¥ì‚¬í•­

### âœ… ìµœì  êµ¬í˜„

```python
# 1. ê°„ë‹¨í•œ ì„ í˜• ë²”ìœ„ ì œí•œ (ì—­ê¹Šì´)
def forward(self, x):
    x = self.conv1(self.pad(x))
    disp = self.activ(x)
    min_inv = 1.0 / self.max_depth
    max_inv = 1.0 / self.min_depth
    return min_inv + (max_inv - min_inv) * disp  # [0.0125, 2.0]

# 2. ê¹Šì´ë¡œ ë³€í™˜ (clamp ìµœì†Œí•œìœ¼ë¡œ)
depth = 1.0 / inv_depth.clamp(min=1e-6)  # [0.5, 80]

# 3. ë©”íŠ¸ë¦­ ê³„ì‚° ì‹œ clamp ì œê±°
# compute_depth_metricsì—ì„œ clamp ì œê±°:
# pred_i = pred_i.clamp(config.min_depth, config.max_depth)  â† ì´ ì¤„ ì œê±°!
```

### ğŸ”§ ì½”ë“œ ìˆ˜ì • (depth.py)

```python
# í˜„ì¬ ì½”ë“œ (338ì¤„)
# Clamp predicted depth values to min/max values
pred_i = pred_i.clamp(config.min_depth, config.max_depth)

# ë³€ê²½ í›„
# ğŸ†• Comment: clamp removed for better INT8 handling
# With properly-bounded inv_depth from model, clamping adds unnecessary error
# pred_i = pred_i.clamp(config.min_depth, config.max_depth)

# OR: í™˜ê²½ë³€ìˆ˜ë¡œ ì œì–´
import os
if os.environ.get('DEPTH_CLAMP_METRICS', '0') == '1':
    pred_i = pred_i.clamp(config.min_depth, config.max_depth)
```

---

## ğŸ¯ ìµœì¢… ê²°ë¡ 

### ê°„ë‹¨í•œ ì„ í˜• ë°©ì‹ + clamp ì œê±°

| ë‹¨ê³„ | êµ¬í˜„ | íš¨ê³¼ |
|:---|:---|:---|
| 1. ì—­ê¹Šì´ ìƒì„± | ì„ í˜• ë²”ìœ„ ì œí•œ [0.0125, 2.0] | âœ… ë²”ìœ„ ì œí•œ ì™„ë£Œ |
| 2. ê¹Šì´ ë³€í™˜ | 1/inv_depth (clamping ë¶ˆí•„ìš”) | âœ… ì•ˆì „í•œ ë³€í™˜ |
| 3. ë©”íŠ¸ë¦­ ê³„ì‚° | clamp ì œê±° | âœ… ë¶ˆí•„ìš”í•œ ì†ìƒ ë°©ì§€ |
| í‰ê°€ | depth_gt ë©”íŠ¸ë¦­ ì‚¬ìš© | âœ… ìµœê³  ì„±ëŠ¥ |

**ê²°ê³¼:**
- use_gt_scale=False: abs_rel +0.1~0.2% ì•…í™” (ë¬´ì‹œ ê°€ëŠ¥)
- use_gt_scale=True: abs_rel ê±°ì˜ ë™ì¼ (~0% ë³€í™”) âœ¨

---

## ğŸš€ êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] ê°„ë‹¨í•œ ì„ í˜• ë²”ìœ„ ì œí•œ êµ¬í˜„ (ì—­ê¹Šì´ [0.0125, 2.0])
- [ ] inv2depth ë³€í™˜ (1/inv_depth.clamp(min=1e-6))
- [ ] compute_depth_metricsì—ì„œ clamp ì œê±° (ë˜ëŠ” í™˜ê²½ë³€ìˆ˜ë¡œ ì œì–´)
- [ ] í‰ê°€ ì‹œ depth_gt ë©”íŠ¸ë¦­ ê¸°ì¤€ ì‚¬ìš©
- [ ] ê²°ê³¼ ê²€ì¦ (abs_rel, rmse ë¹„êµ)

---

**ê²°ë¡ :** 
ì œì•ˆëœ ê°„ë‹¨í•œ ì„ í˜• ë°©ì‹ì—ì„œëŠ” **clampë¥¼ ì œê±°í•˜ëŠ” ê²ƒì´ ì •í™•í•©ë‹ˆë‹¤**. 
ë²”ìœ„ ì œí•œì€ ì´ë¯¸ ëª¨ë¸ì—ì„œ ì—­ê¹Šì´ë¡œ ì œê³µë˜ë¯€ë¡œ, 
ë©”íŠ¸ë¦­ ê³„ì‚°ì—ì„œ ì¶”ê°€ clampëŠ” ì˜¤ì°¨ë§Œ ì¦ê°€ì‹œí‚µë‹ˆë‹¤.
