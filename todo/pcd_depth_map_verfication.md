# PCD 기반 Depth Map 생성 및 검증 이슈

## 1. 문제 현상

- 모델 학습 후 평가 시, `abs_rel` (Absolute Relative Error) 메트릭이 비정상적으로 높게 나타남 (예: 2.5).
- 반면, `rmse` (Root Mean Square Error) 메트릭은 상대적으로 낮게 나타남.
- 이는 모델이 예측한 깊이(depth)와 실제 정답(Ground Truth) 간의 **스케일(scale) 불일치** 문제를 강력하게 시사함.

## 2. 핵심 목표

- 모델이 Inference 시 별도의 스케일 보정(scaling factor 곱셈 등) 없이, **출력값 자체가 실제 거리 단위(미터, m)와 일치**하도록 만드는 것.

## 3. 원인 분석

- **가설:** 모델이 학습에 사용하는 Ground Truth(GT) 깊이 데이터의 스케일이 처음부터 잘못되어, 모델이 잘못된 스케일을 정답으로 인지하고 학습한다.

- **코드 검증:**
    - `packnet_sfm/datasets/kitti_dataset_optimized.py`
    - `packnet_sfm/datasets/ncdb_dataset.py`
    - `packnet_sfm/utils/depth.py`

- **검증 결과:**
    - 데이터 로더(`KITTIDataset`, `NcdbDataset`)는 KITTI 데이터셋의 표준을 따라, `.png` 형식의 GT 깊이 맵을 로드할 때 픽셀 값을 **`256.0`으로 나누는 로직**을 포함하고 있음을 확인.
    - 이는 `.png` 파일에 깊이 값이 `(실제 거리(m) * 256)` 공식에 따라 16비트 정수로 저장되어 있다는 것을 전제로 함.
    - **결론:** 문제의 원인은 데이터 로더가 아닌, **GT 깊이 맵을 생성하여 `.png` 파일로 저장하는 파이PCD라인**에 있을 가능성이 매우 높다. 현재 생성된 GT `.png` 파일이 `실제 거리(m) * 256` 규칙을 따르지 않고, 미터 단위의 거리를 반올림한 정수 값 등으로 잘못 저장되었을 것으로 추정됨.

## 4. 해결 방안 및 검증 계획

1.  **GT 데이터 생성 파이프라인 수정:**
    - PCD(Point Cloud Data)로부터 깊이 맵을 생성하고 `.png` 파일로 저장하는 코드를 검토하고 수정한다.
    - 최종 저장 단계에서 각 픽셀 값이 **`(실제 깊이(m)) * 256`** 공식에 따라 계산된 **16비트 정수(unsigned 16-bit integer)** 값인지 반드시 확인한다.

2.  **수정 후 검증:**
    - 수정된 파이프라인으로 GT 데이터를 다시 생성한다.
    - 생성된 `.png` 파일을 열어 특정 픽셀의 정수 값을 확인하고, 이를 `256.0`으로 나누었을 때 예상되는 미터(m) 단위 깊이 값과 일치하는지 수동으로 검증한다.
    - 수정된 GT 데이터로 모델을 재학습하고, 평가 시 `abs_rel` 메트릭이 정상 범위(스케일 보정을 적용한 `depth_gt` 메트릭과 유사한 수준)로 떨어지는지 확인한다.
